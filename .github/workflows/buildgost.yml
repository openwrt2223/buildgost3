name: Build Gost
on:
  schedule:
    # * is a special character in YAML, so you have to quote this string
    - cron:  '00 15 * * *'
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  BuildGost:
    if: "(! contains(toJSON(github.event.commits.*.message), '[skip-ci]'))"
    runs-on: ubuntu-24.04

    steps:
       - uses: actions/checkout@v4
        with:
          fetch-depth: 0
       
       - name: Build Gost
         id: buildgost
         run: bash scripts/github/workflows/buildgost.sh

       - name: Upload Gost To Artifact
         uses: actions/upload-artifact@v5
         if: steps.buildgost.outputs.status == 'success' && !cancelled()
         with:
           name: gost
           path: ${{ steps.buildgost.outputs.buildgostout }}/*
       
       - name: Generate Release Tag
         id: tag
         if: steps.buildgost.outputs.status == 'success' && !cancelled()
         run: |
           echo "::set-output name=release_tag::$(date +"%Y%m%d%H%M%S")"
           touch release.txt
           echo "编译时间:$(date +"%Y%m%d%H%M%S")" >> release.txt
           echo "gost git sha short:$(cd gost && git rev-parse --short HEAD)" >> release.txt
           echo "gost git sha:$(cd gost && git rev-parse HEAD)" >> release.txt
           echo "源码地址:https://github.com/go-gost/gost/tree/$(cd gost && git rev-parse HEAD)" >> release.txt
           echo "::set-output name=status::success"
       - name: Upload Gost To Release
         uses: softprops/action-gh-release@v2
         if: steps.tag.outputs.status == 'success' && !cancelled()
         env:
           GITHUB_TOKEN: ${{ secrets.GITHUBTOKEN }}
         with:
           tag_name: ${{ steps.tag.outputs.release_tag }}
           body_path: release.txt
           files: ${{ steps.buildgost.outputs.buildgostout }}/*

       - name: Delete workflow runs
         uses: GitRML/delete-workflow-runs@main
         with:
           retain_days: 1
           keep_minimum_runs: 1

       - name: Remove Old Releases
         uses: dev-drprasad/delete-older-releases@v0.3.4
         if: steps.tag.outputs.status == 'success' && !cancelled()
         with:
           keep_latest: 1
           delete_tags: true
         env:
           GITHUB_TOKEN: ${{ secrets.GITHUBTOKEN }}
